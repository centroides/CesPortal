<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <title>Centroid Engineering Solutions</title>
    <link rel="icon" type="image/jpeg" href="static/ces_logo.png">
    <link rel="stylesheet" href="../static/res_style.css">
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <!-- <script src="https://kit.fontawesome.com/f8e1a90484.js" crossorigin="anonymous"></script> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

</head>

<body>

    <input type="checkbox" id="menu-toggle">

    <div class="sidebar">

        <div class="side-header">
            <h3>C<span>entroid</span></h3>
        </div>

        <div class="side-content">

            <div class="profile">
                <div class="profile-img bg-img" style="background-image: url(../static/1.png)"></div>
                <h4>{{user['name']}}</h4>
                <small>{{department_code}}</small>
            </div>

            <div class="side-menu">
                <ul>

                    {% if department_code == 1000 %}
                    <li>
                        <a href="/admin">
                            <span class="fa-solid fa-user-tie"></span>
                            <small>Admin</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if user_access['Accounts'] == 'On' %}
                    <li>
                        <a href="/accounts">
                            <span class="fa-solid fa-file-invoice-dollar"></span>
                            <small>Accounts</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleEnquiry'] == 'On' %}
                    <li>
                        <a href="/admin_enquiry">
                            <span class="fa-solid fa-handshake"></span>
                            <small>Leads</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleHR'] == 'On' %}
                    <li>
                        <a href="/hr">
                            <span class="fa-solid fa-user-plus"></span>
                            <small>HR</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['togglePlanner'] == 'On' %}
                    <li>
                        <a href="/planner">
                            <span class="fa-solid fa-calendar-check"></span>
                            <small>Planner</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleProfile'] == 'On' %}
                    <li>
                        <a href="/profile">
                            <span class="fa-solid fa-user"></span>
                            <small>Profile</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleProjects'] == 'On' %}
                    <li>
                        <a href="/projects" class="active">
                            <span class="fa-solid fa-chart-simple"></span>
                            <small>Project</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['togglePurchase'] == 'On' %}
                    <li>
                        <a href="/purchase">
                            <span class="fa-solid fa-cart-shopping"></span>
                            <small>Purchase</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if user_access['toggleResources'] == 'On' %}
                    <li>
                        <a href="/resources">
                            <span class="fa-solid fa-recycle"></span>
                            <small>Resources</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if department_code == 1000 %}
                    <li>
                        <a href="/settings">
                            <span class="fa-solid fa-gears"></span>
                            <small>Settings</small>
                        </a>
                    </li>
                    {% endif %}

                    <li>
                        <a href="{{ url_for('logout') }}">
                            <span class="fa-solid fa-right-from-bracket"></span>
                            <small>Log Out</small>
                        </a>
                    </li>
                </ul>
            </div>

        </div>

    </div>

    <div class="main-content">

        <div class="page-content" style="background-color: white;">

            <div class="page-header" style="background-color: white;">

                <nav class="navbar1">

                    <ul id="menuList1" class="navitems1">

                        {% if user_access['toggleDashboard'] == 'On' %}
                        <li class="active">
                            <a href="{{ url_for('projects') }}" class="link">
                                <i class="fa-solid fa-chart-line" style="margin-right: 5px;"></i> Dashboard
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleProjectStatus'] == 'On' %}
                        <li>
                            <a href="{{ url_for('prj_status') }}" class="link">
                                <i class="fa-solid fa-clipboard-check" style="margin-right: 5px;"></i> Status
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleHoursEdit'] == 'On' %}
                        <li>
                            <a href="{{ url_for('hours_edit') }}" class="link">
                                <i class="fa-solid fa-clock-rotate-left" style="margin-right: 5px;"></i> Hours Edit
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleMaterialReceipt'] == 'On' %}
                        <li><a href="{{ url_for('Material_Receipt') }}" class="link"><i
                                    class="fa-solid fa-industry"></i>
                                Material Receipt</a></li>
                        {% endif %}

                        {% if user_access['toggleHoursView'] == 'On' %}
                        <li>
                            <a href="{{ url_for('hrs_view') }}" class="link">
                                <i class="fa-solid fa-clock" style="margin-right: 5px;"></i> Hours View
                            </a>
                        </li>
                        {% endif %}

                    </ul>

                    <div class="menu-icon">
                        <i class="fa-solid fa-bars" onclick="toggleMenu()"></i>
                    </div>

                    <script>
                        let menuList1 = document.getElementById("menuList1");
                        menuList1.style.maxHeight = "0px";

                        function toggleMenu1() {
                            if (menuList1.style.maxHeight == "0px") {
                                menuList1.style.maxHeight = "300px";
                            } else {
                                menuList1.style.maxHeight = "0px";
                            }
                        }
                    </script>

                </nav>

                <div class="line"></div>

            </div>

            <div class="search_container">

                <div class="timenav">
                    <link rel="stylesheet"
                        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

                    <ul id="menuList1" class="timebar">
                        {% if user_access['toggleOverview'] == 'On' and (project_details.pm == user['name'] or
                        department_code in [10, 11, 16, 1000]) %}
                        <li>
                            <a href="{{ url_for('project_details_page', id=project_id) }}">
                                <i class="fa-solid fa-chart-bar"></i> Overview
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleHrsView'] == 'On' and (project_details.pm == user['name'] or
                        department_code in [10, 11, 16, 1000]) %}
                        <li>
                            <a href="/prj_hrs_view?project_id={{ project_id }}">
                                <i class="fa-regular fa-clock"></i> Hrs View
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['toggleGeneratePR'] == 'On' %}
                        <li>
                            <a href="/project_pr?project_id={{ project_id }}">
                                <i class="fa-solid fa-file-invoice"></i> Generate PR
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleprjViewPO'] == 'On' %}
                        <li>
                            <a href="/project_po?project_id={{ project_id }}">
                                <i class="fa-solid fa-file-contract"></i> View PO's
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['toggleViewClaims'] == 'On' %}
                        <li>
                            <a href="/claiminfo?project_id={{ project_id }}">
                                <i class="fa-solid fa-receipt"></i> View Claims
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['togglePrjViewDO'] == 'On' %}
                        <li>
                            <a href="{{ url_for('project_do', project_id=project_id) }}">
                                <i class="fa-solid fa-truck-moving"></i> DO's
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['togglePaymentRequests'] == 'On' %}
                        <li>
                            <a href="{{ url_for('prj_pay_req', project_id=project_id) }}" class="active">
                                <i class="fa-solid fa-money-bill-wave"></i> Payment Request
                            </a>
                        </li>
                        {% endif %}

                        <li>
                            <a href="{{ url_for('prj_planner', project_id=project_id) }}">
                                <i class="fa-solid fa-calendar-check"></i> Planner
                            </a>
                        </li>

                    </ul>


                    <div class="menu-icon1">
                        <i class="fa-solid fa-bars" onclick="toggleMenu1()"></i>
                    </div>
                </div>

                <div class="line1"></div>

                <style>
                    .timenav .active i {
                        color: white !important;
                        /* Ensures icon turns white */
                    }

                    .search_container {

                        width: 100%;
                        padding: 10px;
                    }

                    .line1 {
                        margin: 3px auto;
                        /* Centers horizontally */
                        height: 2px;
                        background-color: rgb(82, 79, 79);
                        width: 97%;
                        display: block;
                        /* Ensures it behaves as a block element */
                    }


                    /* Style for headings and icons */
                    .timenav a,
                    .timenav i {
                        color: #8d7f5c !important;
                        font-weight: bold;
                    }

                    /* Active link style */
                    .timenav .active {
                        background-color: #FF6347 !important;
                        color: white !important;
                        padding: 10px;
                        font-weight: bold;
                        border-top-left-radius: 5px;
                        border-top-right-radius: 5px;
                    }

                    .timebar {
                        display: flex;
                        justify-content: space-around;
                        align-items: center;
                        list-style: none;
                        margin: 0;
                        padding: 0;
                        width: 100%;
                    }

                    .timebar li {
                        flex: 1 1 20%;
                        margin: 5px;
                        text-align: center;
                    }

                    .link1 {
                        color: #8d7f5c;
                        font-size: 16px;
                        font-weight: bold;
                        transition: color 0.3s ease;
                        cursor: pointer;
                    }
                </style>

            </div>

            <div class="title-box">

                <div class="title-item cssanimation open">
                    <span>Project ID : {{project_details.id}} </span>
                </div>

                <div class="title-item cssanimation open">
                    <span>Project Name : {{project_details.project_name}}</span>
                </div>

                <div class="title-item cssanimation open">
                    <span>Project Manager : {{project_details.pm}}</span>
                </div>

                {% if user_access['toggleCreatePaymentRequest'] == 'On' %}
                <div class="title-item cssanimation open">
                    <button type="button" id="openModalButton" data-project-id="{{ project_id }}"
                        class="new-enquiry-btn">
                        + New Request
                    </button>
                </div>
                {% endif %}

                <style>
                    .new-enquiry-btn {
                        background: linear-gradient(45deg, #007AFF, #34AADC, #5856D6, #FF2D55);
                        background-size: 200% 200%;
                        color: white;
                        font-weight: bold;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        transition: all 0.4s ease-in-out;
                        box-shadow: 10px 10px 10px rgba(0, 122, 255, 0.3);
                        /* Soft shadow */
                    }

                    /* Hover effect: Darker Gradient + Glow */
                    .new-enquiry-btn:hover {
                        background: linear-gradient(45deg, #0056A3, #2598C1, #4741C1, #D91D48);
                        background-size: 200% 200%;
                        box-shadow: 0px 6px 12px rgba(0, 86, 179, 0.5);
                        /* Stronger shadow on hover */
                        transform: scale(1.05);
                    }



                    #openModalButton:hover {
                        background-color: #04a389;
                        /* Darker shade for hover */
                        color: #ffffff;
                        /* Ensure text stays visible */
                        border-color: #ffffff;
                        /* Highlight border */
                        transform: scale(1.05);
                        /* Slight zoom effect */
                    }
                </style>

                <!-- Modal Structure -->
                <div id="modal" class="modal">

                    <div class="modal-content">

                        <div class="button-container1">
                            <h2>New Payment Request
                            </h2>

                            <span class="close-button">&times;</span>

                        </div>

                        <form class="p-3" action="/prj_pay_req" method="POST" enctype="multipart/form-data">

                            <div class="container">

                                <div class="invice_header">

                                    <div class="flex-item" style="display: none;">
                                        <label for="project_id" class="form-label">Project ID <span
                                                style="color: red;">*</span></label>
                                        <input type="number" class="form-control" id="project_id" name="project_id"
                                            value="{{ project_details.id }}" readonly
                                            style="background-color: whitesmoke;" required>
                                    </div>

                                    <div class="flex-item" style="display: none;">
                                        <label for="project_name" class="form-label">Project Name<span
                                                style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="project_name" name="project_name"
                                            value="{{ project_details.project_name }}" readonly
                                            style="background-color: whitesmoke;" required>
                                    </div>

                                    <div class="flex-item">
                                        <label for="project_name" class="form-label">Project<span
                                                style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="project_name" name="project_name"
                                            value="{{ project_details.id }}-{{project_details.project_name}}" readonly
                                            style="background-color: whitesmoke;" required>
                                    </div>

                                    <div class="flex-item" style="display: none;">
                                        <label for="pay_req_no" class="form-label"> Request ID <span
                                                style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="pay_req_no" name="pay_req_no"
                                            value="{{ project_details.pay_req_no }}" readonly
                                            style="background-color: whitesmoke;" required>
                                    </div>

                                    <div class="flex-item" style="display: none;">
                                        <label for="pay_date" class="form-label">Request Date <span
                                                style="color: red;">*</span></label>
                                        <input type="date" class="form-control" id="pay_date" name="pay_date"
                                            value="{{ project_details.pay_date }}" readonly
                                            style="background-color: whitesmoke;" required>
                                    </div>

                                    <div class="flex-item">
                                        <label for="po_number" class="form-label">PO Number <span
                                                style="color: red;">*</span></label>
                                        <select class="form-control" id="po_number" name="po_number" required>
                                            <option value="" disabled selected>Select PO Number</option>
                                            {% for po in project_details.po_numbers %}
                                            <option value="{{ po }}">{{ po }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="flex-item">
                                        <label for="supplier_name" class="form-label">Supplier Name<span
                                                style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="supplier_name" name="supplier_name"
                                            readonly style="background-color: whitesmoke;" required>
                                    </div>

                                    <div class="flex-item" style="display: none;">
                                        <label for="pototal_valueField" class="form-label">Po Total<span
                                                style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="pototal_valueField"
                                            name="pototal_valueField" readonly style="background-color: whitesmoke;"
                                            required>
                                    </div>

                                </div>

                                <div class="invice_header">

                                    <div class="flex-item">
                                        <label for="invoice_no" class="form-label">Invoice No<span
                                                style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="invoice_no" name="invoice_no"
                                            required>
                                    </div>

                                    <div class="flex-row">

                                        <div class="flex-item" id="downPayWrapper">
                                            <label for="DownPay" class="form-label">DownPay (Only %)</label>
                                            <input type="number" step="any" class="form-control" id="DownPay"
                                                name="DownPay" required>
                                        </div>

                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const downPayInput = document.getElementById('DownPay');
                                                const tableSection = document.querySelector('.table-responsive1');

                                                downPayInput.addEventListener('input', function () {
                                                    if (this.value && parseFloat(this.value) !== 0) {
                                                        tableSection.style.display = 'none';
                                                    } else {
                                                        tableSection.style.display = 'block';
                                                    }
                                                });
                                            });
                                        </script>

                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const poNumberSelect = document.getElementById('po_number');
                                                const downPayToCal = document.getElementById('DownPay_to_cal_total');
                                                const downPay = document.getElementById('DownPay');
                                                const downPayWrapper = document.getElementById('downPayWrapper');

                                                function toggleDownPayField() {
                                                    const value = parseFloat(downPayToCal.value);
                                                    if (!isNaN(value) && value !== 0) {
                                                        downPay.disabled = true;
                                                        downPay.value = ''; // optional: clear value
                                                    } else {
                                                        downPay.disabled = false;
                                                    }
                                                }

                                                // Check when PO number is changed (after auto-filling downPayToCal)
                                                poNumberSelect.addEventListener('change', function () {
                                                    // Use a small timeout to wait for `downPayToCal` to be updated
                                                    setTimeout(toggleDownPayField, 100);
                                                });

                                                // Also watch for manual changes in downPayToCal, if needed
                                                downPayToCal.addEventListener('input', toggleDownPayField);

                                                // Initial check in case values are prefilled
                                                toggleDownPayField();
                                            });
                                        </script>





                                        <div class="flex-item" style="display: none;">
                                            <label for="DownPay_to_cal_total" class="form-label">DownPay (Only
                                                %)</label>
                                            <input type="number" step="any" class="form-control"
                                                id="DownPay_to_cal_total" name="DownPay_to_cal_total" required>
                                        </div>
                                        <div class="flex-item">
                                            <label for="Invoice_date" class="form-label">Invoice Date <span
                                                    style="color: red;">*</span></label>
                                            <input type="date" class="form-control" id="Invoice_date"
                                                name="Invoice_date" required>
                                        </div>

                                    </div>

                                    <div class="flex-item">
                                        <label for="Terms" class="form-label">Terms </label>
                                        <div style="display: flex; gap: 2px;">
                                            <input type="number" class="form-control" id="Terms" name="Terms" required>
                                            <select class="form-control" id="time_period" name="time_period">
                                                <option value="Days">Days</option>
                                                <option value="COD">COD</option>
                                                <option value="Advance">Advance</option>
                                            </select>
                                        </div>
                                    </div>

                                </div>

                                <script>
                                    document.getElementById("invoice_no").addEventListener("blur", function () {
                                        const invoiceNo = this.value.trim();
                                        const supplierName = document.getElementById("supplier_name").value.trim();

                                        if (invoiceNo && supplierName) {
                                            fetch("/check_invoice_number_supplier_name", {
                                                method: "POST",
                                                headers: {
                                                    "Content-Type": "application/json"
                                                },
                                                body: JSON.stringify({
                                                    invoice_no: invoiceNo,
                                                    supplier_name: supplierName
                                                })
                                            })
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (data.exists) {
                                                        alert("This invoice number already exists for the selected supplier!");
                                                        document.getElementById("invoice_no").value = "";
                                                        document.getElementById("invoice_no").focus();
                                                    }
                                                })
                                                .catch(error => console.error("Error:", error));
                                        }
                                    });
                                </script>

                                <div class="invice_header">

                                    <div class="flex-item">
                                        <label for="comments" class="form-label">Comments</label>
                                        <textarea class="form-control" id="comments" name="comments"
                                            rows="9"></textarea>
                                    </div>

                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const invoiceDateInput = document.getElementById('Invoice_date');
                                            const gstField = document.getElementById('gst_percent'); // Input field for GST

                                            invoiceDateInput.addEventListener('change', async function () {
                                                const selectedDate = this.value;

                                                try {
                                                    const response = await fetch('/get_gst', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                        },
                                                        body: JSON.stringify({ invoice_date: selectedDate }),
                                                    });

                                                    if (response.ok) {
                                                        const data = await response.json();
                                                        // console.log(".....gst ......data......", data);
                                                        gstField.value = data.gst_value; // Update the input field value
                                                    } else {
                                                        gstField.value = ''; // Clear the field if no GST value is available
                                                        alert('No GST value available for the selected date.');
                                                    }
                                                } catch (error) {
                                                    console.error('Error fetching GST value:', error);
                                                    gstField.value = ''; // Clear the field on error
                                                    alert('Error fetching GST value.');
                                                }
                                            });
                                        });
                                    </script>

                                    <style>
                                        .drop-zone {
                                            border: 2px dashed #007bff;
                                            border-radius: 10px;
                                            padding: 5px;
                                            text-align: center;
                                            cursor: pointer;
                                            transition: 0.3s;
                                        }

                                        .drop-zone:hover {
                                            background-color: #f8f9fa;
                                        }

                                        .drop-zone p {
                                            margin: 0;
                                            font-weight: bold;
                                            color: #007bff;
                                            font-size: 11px;

                                        }

                                        .drop-zone input {
                                            display: none;
                                        }

                                        .file-preview {
                                            color: #333;
                                        }
                                    </style>

                                    <script>
                                        function handleDragOver(event) {
                                            event.preventDefault();
                                            event.dataTransfer.dropEffect = "copy";
                                        }

                                        function handleDrop(event) {
                                            event.preventDefault();
                                            const fileInput = document.getElementById('attachment');
                                            fileInput.files = event.dataTransfer.files;
                                            updateFileName(fileInput);
                                        }

                                        function updateFileName(input) {
                                            const filePreview = document.getElementById("filePreview");
                                            if (input.files.length > 0) {
                                                filePreview.textContent = "" + input.files[0].name;
                                            } else {
                                                filePreview.textContent = "";
                                            }
                                        }
                                    </script>

                                </div>

                                <div class="invice_header">

                                    <div class="flex-item">
                                        <label for="attachment" class="form-label">Attach Invoice<span
                                                style="color: red;">*</span></label>
                                        <div class="drop-zone" style="max-height: 150px; min-height: 150px;"
                                            onclick="document.getElementById('attachment').click()"
                                            ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                                            <p>Drag & Drop here or click to select</p>
                                            <input type="file" class="form-control" id="attachment" name="attachment"
                                                accept="*/*" required onchange="updateFileName(this)">
                                            <div class="file-preview" id="filePreview"></div>
                                        </div>
                                    </div>

                                </div>


                            </div>

                            <style>
                                .container {
                                    background-color: white;
                                    padding: 2px;
                                    border-radius: 10px;
                                    display: flex;
                                    flex: 1;
                                    gap: 10px;
                                }

                                .invice_header {
                                    width: 100%;
                                    padding: 0px;
                                    background-color: #e0f7fa;
                                    border-radius: 5px;
                                }
                            </style>

                            <div class="table-responsive1" style="margin-top: 10px;">

                                <table class="mat_rec_table" width="100%" id="dynamicTable">

                                    <thead>

                                        <tr>

                                            <th style="width: 3%;">S/N</th>
                                            <th style="width: 3%; ">ID</th>
                                            <th style="width: 10%;">Part No</th>
                                            <th style="width: 25%;">Item Name</th>
                                            <th style="width: 4%;">UOM</th>
                                            <th style="width: 5%;">Actual Qty</th>
                                            <th style="width: 6%;">Unit Price</th>
                                            <th style="width: 6%;">Total</th>
                                            <th style="width: 6%;">Pending Qty</th>
                                            <th style="width: 6%;">Pending Amt</th>
                                            <th style="width: 6%;">Req Qty
                                                <input type="checkbox" id="selectPending"
                                                    onclick="copyAllPendingQty(this)" disabled>
                                            </th>

                                            <th style="width: 6%;">Amount</th>

                                            <th style="width: 3%;">
                                                <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                                            </th>

                                        </tr>

                                    </thead>

                                    <tbody id="itemsTableBody">

                                        <tr>
                                            <td colspan="13" class="text-center" style="
                                                font-weight: bold; 
                                                font-size: 1.1rem; 
                                                color: #0c5460; 
                                                background-color: #d1ecf1; 
                                                padding: 12px; 
                                                border-radius: 6px;">
                                                <i class="fa-solid fa-circle-info"
                                                    style="color: #17a2b8; margin-right: 6px;"></i>
                                                Select PO Number to load items
                                            </td>
                                        </tr>


                                    </tbody>

                                </table>

                                <style>
                                    .button-container1 {
                                        display: flex;
                                        flex: 1;
                                        justify-content: space-between;
                                        align-items: center;
                                        width: 100%;
                                        margin-top: 10px;
                                        gap: 10px;
                                    }
                                </style>

                            </div>

                            <div class="button-container1">
                                <div>
                                    <label for="gst_stat">GST Status:</label>
                                    <input id="gst_stat" class="form-control" type="text" step="any" readonly>
                                </div>

                                <div>
                                    <label for="total_amount">Amount:</label>
                                    <input id="total_amount" class="form-control" type="number" step="any" readonly>
                                </div>

                                <div>
                                    <label for="discount_percent">Discount %:</label>
                                    <input id="discount_percent" class="form-control" type="number" step="any" readonly>
                                </div>

                                <div>
                                    <label for="gst_percent">GST %:</label>
                                    <input id="gst_percent" class="form-control" type="number" step="any" readonly>
                                </div>

                                <div>
                                    <label for="gst_value">GST Value:</label>
                                    <input id="gst_value" class="form-control" type="text" step="any" readonly>
                                </div>

                                <div>
                                    <label for="overall_total_amount">Total (Including GST):</label>
                                    <input id="overall_total_amount" class="form-control" type="number" step="any"
                                        readonly>
                                </div>

                                <div>
                                    <button type="button" class="custom-btn new-enquiry-btn">Submit Request</button>

                                </div>
                            </div>


                        </form>

                    </div>

                </div>

            </div>

            <script>
                // Function to enable the checkbox only when a date is selected
                function enableReqAllCheckbox() {
                    const invoiceDate = document.getElementById('Invoice_date').value;
                    const reqAllCheckbox = document.getElementById('selectPending');

                    if (invoiceDate) {
                        reqAllCheckbox.disabled = false; // Enable checkbox when date is selected
                    } else {
                        reqAllCheckbox.disabled = true; // Disable checkbox if no date is selected
                        reqAllCheckbox.checked = false; // Uncheck the checkbox if it's disabled
                    }
                }

                // Function to copy Pending Qty to Request Qty for all rows when "Req ALL" checkbox is checked
                function copyAllPendingQty(checkbox) {
                    const itemsTableBody = document.getElementById('itemsTableBody');
                    const rows = itemsTableBody.querySelectorAll('tr');

                    // Check if the checkbox is disabled
                    if (checkbox.disabled) {
                        alert('Please select an invoice date first.');
                        checkbox.checked = false; // Uncheck the checkbox if disabled
                        return; // Prevent further execution if checkbox is disabled
                    }

                    rows.forEach(row => {
                        const requestQtyInput = row.querySelector('input[name="request_qty[]"]');
                        const balanceQty = row.querySelector('input[name="balance_qty[]"]');
                        const unitPrice = parseFloat(row.querySelector('input[name="unit_price[]"]').value) || 0;

                        if (checkbox.checked) {
                            // If checkbox is checked, copy Pending Qty (balance_qty) to Request Qty
                            if (balanceQty) {
                                requestQtyInput.value = balanceQty.value;
                            }
                        } else {
                            // If checkbox is unchecked, reset Request Qty to 0
                            if (requestQtyInput) {
                                requestQtyInput.value = 0;
                            }
                        }

                        // Trigger updateAmount to recalculate the amounts and total fields
                        updateAmount(requestQtyInput, unitPrice, parseFloat(balanceQty.value));
                    });

                    // Recalculate the total amount after updating all rows
                    updateTotalAmount();
                }
            </script>

            <!-- form submit -->
            <script>

                document.querySelector('.custom-btn').removeEventListener('click', handleSubmission);
                document.querySelector('.custom-btn').addEventListener('click', handleSubmission);

                async function handleSubmission(event) {
                    event.preventDefault(); // Prevent default form submission

                    const button = event.target;
                    const originalButtonText = button.textContent;
                    button.textContent = "Submitting the request...";
                    button.disabled = true;

                    const selectedRows = [];
                    const rows = document.querySelectorAll('#itemsTableBody tr');

                    rows.forEach(row => {
                        const checkbox = row.querySelector('input[type="checkbox"][name="selected_items[]"]');
                        if (checkbox && checkbox.checked) {
                            // Parse numeric values to ensure they're numbers
                            const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
                            const unit_price = parseFloat(row.querySelector('input[name="unit_price[]"]').value) || 0;
                            const total = parseFloat(row.querySelector('input[name="total[]"]').value) || 0;
                            const balance_qty = parseFloat(row.querySelector('input[name="balance_qty[]"]').value) || 0;
                            const balance_amount = parseFloat(row.querySelector('input[name="balance_amount[]"]').value) || 0;
                            const request_qty = parseFloat(row.querySelector('input[name="request_qty[]"]').value) || 0;
                            const amount = parseFloat(row.querySelector('input[name="amount[]"]').value) || 0;

                            // Debug log before pushing to selectedRows
                            console.log(`Selected row - ID: ${row.querySelector('input[name="id[]"]').value}, ` +
                                `Qty: ${request_qty}, ` +
                                `Price: ${unit_price}, ` +
                                `Amount: ${amount}`);

                            selectedRows.push({
                                id: row.querySelector('input[name="id[]"]').value,
                                part_no: row.querySelector('input[name="part_no[]"]').value,
                                item_name: row.querySelector('input[name="item_name[]"]').value,
                                uom: row.querySelector('input[name="uom[]"]').value,
                                quantity: quantity,
                                unit_price: unit_price,
                                total: total,
                                balance_qty: balance_qty,
                                balance_amount: balance_amount,
                                request_qty: request_qty,
                                amount: amount,
                            });
                        }
                    });

                    const project_id = document.getElementById('project_id').value;
                    const pay_req_no = document.getElementById('pay_req_no').value;
                    const pay_date = document.getElementById('pay_date').value;
                    const Terms = document.getElementById('Terms').value;
                    const time_period = document.getElementById('time_period').value; // get time period
                    const po_number = document.getElementById('po_number').value;
                    const invoice_no = document.getElementById('invoice_no').value;
                    const Invoice_date = document.getElementById('Invoice_date').value;
                    const attachment = document.getElementById('attachment').files[0];

                    const missingFields = [];

                    if (!project_id) missingFields.push('Project ID');
                    if (!pay_req_no) missingFields.push('Payment Request ID');
                    if (!pay_date) missingFields.push('Request Date');
                    if (!po_number) missingFields.push('PO Number');
                    if (!invoice_no) missingFields.push('Invoice No');
                    if (!Invoice_date) missingFields.push('Invoice Date');
                    if (!attachment) missingFields.push('Attachment');

                    // Only check Terms if time_period is not COD
                    // Check Terms if time_period is neither 'COD' nor 'Advance'
                    if (time_period !== 'COD' && time_period !== 'Advance' && !Terms) {
                        missingFields.push('Terms');
                    }


                    if (missingFields.length > 0) {
                        alert(`The following fields are required:\n- ${missingFields.join('\n- ')}`);
                        button.textContent = originalButtonText;
                        button.disabled = false;
                        return;
                    }

                    const downPayValue = document.getElementById('DownPay').value;
                    const overallTotalAmount = document.getElementById('overall_total_amount').value;

                    if ((!downPayValue || parseFloat(downPayValue) === 0) && parseFloat(overallTotalAmount) === 0) {
                        alert('Overall total amount cannot be zero. Please add Quantity or specify DownPay.');
                        button.textContent = originalButtonText;
                        button.disabled = false;
                        return;
                    }

                    const formData = new FormData();
                    formData.append('project_id', project_id);
                    formData.append('pay_req_no', pay_req_no);
                    formData.append('pay_date', pay_date);
                    formData.append('po_number', po_number);
                    formData.append('invoice_no', invoice_no);
                    formData.append('Invoice_date', Invoice_date);
                    formData.append('total_amount', document.getElementById('total_amount').value);
                    formData.append('gst_stat', document.getElementById('gst_stat').value);
                    formData.append('gst_value', document.getElementById('gst_value').value);
                    formData.append('overall_total_amount', document.getElementById('overall_total_amount').value);
                    formData.append('supplier_name', document.getElementById('supplier_name').value);
                    formData.append('project_name', document.getElementById('project_name').value);
                    formData.append('Terms', document.getElementById('Terms').value);
                    formData.append('time_period', document.getElementById('time_period').value);
                    formData.append('downpayment', document.getElementById('DownPay').value);
                    formData.append('comments', document.getElementById('comments').value);
                    formData.append('gst_percent', document.getElementById('gst_percent').value);
                    formData.append('attachment', attachment);
                    formData.append('items', JSON.stringify(selectedRows));



                    // Check if no rows selected and DownPay is also empty
                    if (selectedRows.length === 0 && (!downPayValue || parseFloat(downPayValue) === 0)) {
                        alert('Please select at least one row or enter DownPay percentage before submitting.');
                        button.textContent = originalButtonText;
                        button.disabled = false;
                        return;
                    }

                    try {
                        const response = await fetch('/prj_pay_req', {
                            method: 'POST',
                            body: formData,
                        });

                        if (response.ok) {
                            alert('Payment request submitted successfully.');
                            window.location.reload();
                        } else {
                            alert('Failed to submit the payment request. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error submitting payment request:', error);
                        alert('An error occurred while submitting the payment request.');
                    } finally {
                        button.textContent = originalButtonText;
                        button.disabled = false;
                    }
                }

            </script>

            <!-- JavaScript for Modal and Fetching Data -->
            <script>

                document.getElementById('Invoice_date').addEventListener('change', function () {
                    const invoiceDate = this.value;
                    const tableInputs = document.querySelectorAll('#dynamicTable input');

                    if (invoiceDate) {
                        // Enable all inputs in the table
                        tableInputs.forEach(input => input.disabled = false);
                    } else {
                        // Disable all inputs in the table
                        tableInputs.forEach(input => input.disabled = true);
                        alert('Please select a valid Invoice Date before editing table entries.');
                    }
                });

                document.getElementById('openModalButton').onclick = async function () {
                    const modal = document.getElementById('modal');
                    const projectId = this.getAttribute('data-project-id');

                    try {
                        // Fetch PO numbers
                        const response = await fetch('/get_po_numbers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ project_id: projectId })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const poNumberDropdown = document.getElementById('po_number');
                            const payReqNoInput = document.getElementById('pay_req_no');
                            const payDateInput = document.getElementById('pay_date');

                            poNumberDropdown.innerHTML = '<option value="" disabled selected>Select PO Number</option>';
                            data.po_numbers.forEach(po => {
                                const option = document.createElement('option');
                                option.value = po;
                                option.textContent = po;
                                poNumberDropdown.appendChild(option);
                            });
                            payReqNoInput.value = data.pay_req_no;
                            payDateInput.value = data.pay_date;

                            modal.style.display = 'flex';
                        } else {
                            alert(data.error || 'Failed to fetch PO numbers');
                        }
                    } catch (error) {
                        console.error('Error fetching PO numbers:', error);
                        alert('An error occurred while fetching PO numbers');
                    }
                };

                document.getElementById('po_number').addEventListener('change', async function () {
                    const poNumber = this.value;
                    const projectId = document.getElementById('project_id').value;
                    const itemsTableBody = document.getElementById('itemsTableBody');
                    const poDetailsElement = document.getElementById('po_details'); // Reference the PO details element
                    const totalAmountField = document.getElementById('total_amount'); // Reference total amount field

                    try {
                        const response = await fetch('/get_po_items', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ po_number: poNumber, project_id: projectId })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const poDetails = data.po_details;
                            const itemList = data.item_list;
                            const gst_status = data.gst_status;

                            console.log(poDetails)

                            const supplier_nameField = document.getElementById('supplier_name');
                            supplier_nameField.value = poDetails.Supplier_Name || 'N/A';

                            const pototal_valueField = document.getElementById('pototal_valueField');
                            pototal_valueField.value = poDetails.total || 'N/A';

                            const gst_statField = document.getElementById('gst_stat');
                            gst_statField.value = gst_status;

                            const discount_percentField = document.getElementById('discount_percent');
                            discount_percentField.value = poDetails.Discount;



                            const DownPay_to_cal_totalField = document.getElementById('DownPay_to_cal_total');
                            DownPay_to_cal_totalField.value = poDetails.downpayment;

                            // Check if po_details element exists before modifying it
                            if (poDetailsElement) {
                                poDetailsElement.innerText = `PO Number: ${poDetails.PO_no}, Supplier: ${poDetails.Supplier_Name}`;
                            }

                            itemsTableBody.innerHTML = ''; // Clear previous rows
                            totalAmountField.value = 0; // Reset total amount

                            if (itemList.length === 0) {
                                itemsTableBody.innerHTML = '<tr><td colspan="12" class="text-center">No items found for the selected PO Number.</td></tr>';
                            } else {
                                itemList.forEach((item, index) => {
                                    const row = `
                                            <tr>
                                                <td class="text-center">${index + 1}</td>
                                                <td><input  class="form-control" type="text" name="id[]" value="${item.id}" readonly></td>
                                                <td><input  class="form-control" type="text" name="part_no[]" value="${item.Part_No}" readonly></td>
                                                <td><input  class="form-control" type="text" name="item_name[]" value="${item.item}" readonly></td>
                                                <td><input  class="form-control" type="text" name="uom[]" value="${item.uom}" readonly></td>
                                                <td><input  class="form-control" type="number" name="quantity[]" value="${item.quantity}" readonly></td>
                                                <td><input  class="form-control" type="number" name="unit_price[]" value="${item.Unit_Price}" readonly></td>
                                                <td><input  class="form-control" type="number" name="total[]" value="${item.total}" readonly></td>
                                                <td><input  style = "background-color: rgb(230, 165, 141);" class="form-control" type="number" name="balance_qty[]" value="${item.balance_qty}" readonly></td>
                                                <td><input  style = "background-color: rgb(230, 165, 141);" class="form-control" type="number" name="balance_amount[]" value="${item.balance_amount}" readonly></td>

                                                <td>
                                                    <input class="form-control" type="number" name="request_qty[]" step="any" value="0" 
                                                        oninput="updateAmount(this, ${item.Unit_Price}, ${item.balance_qty})" disabled>
                                                </td>
                                                <td>
                                                    <input class="form-control" type="number" name="amount[]" step="any" value="0" 
                                                        oninput="updateRequestQty(this, ${item.Unit_Price}, ${item.balance_qty})" disabled>
                                                </td>
                                                <td><input type="checkbox" name="selected_items[]" value="${item.id}"></td>
                                            </tr>`;
                                    itemsTableBody.insertAdjacentHTML('beforeend', row);
                                });
                            }
                        } else {
                            alert('Failed to fetch items or PO details. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error fetching items:', error);
                        alert('An error occurred while fetching items.');
                    }
                });

                // Update amount when request quantity changes
                function updateAmount(input, unitPrice, balance_qty) {
                    const amountField = input.closest('tr').querySelector('input[name="amount[]"]');
                    const downPayInput = document.getElementById('DownPay_to_cal_total');  // Assuming it's a global field

                    if (parseFloat(input.value) > balance_qty) {
                        input.value = balance_qty;
                        alert(`Request quantity cannot exceed the balance quantity (${balance_qty}).`);
                    }

                    const requestQty = parseFloat(input.value) || 0;
                    const rawAmount = requestQty * unitPrice;

                    const downPayPercent = parseFloat(downPayInput.value);
                    if (!isNaN(downPayPercent) && downPayPercent > 0) {
                        const adjustedAmount = rawAmount - (rawAmount * downPayPercent / 100);
                        amountField.value = adjustedAmount.toFixed(2);
                    } else {
                        amountField.value = rawAmount.toFixed(2);
                    }

                    updateTotalAmount();
                }


                // Update request quantity when amount changes
                function updateRequestQty(input, unitPrice, balance_qty) {
                    const requestQtyField = input.closest('tr').querySelector('input[name="request_qty[]"]');
                    const amount = parseFloat(input.value) || 0;
                    const calculatedQty = amount / unitPrice;
                    if (calculatedQty > balance_qty) {
                        input.value = (balance_qty * unitPrice).toFixed(2);
                        alert(`Amount exceeds the value for the balance quantity (${balance_qty}).`);
                    }
                    requestQtyField.value = Math.min(calculatedQty, balance_qty).toFixed(2);
                    updateTotalAmount();
                }

                // Update the total amount
                function updateTotalAmount() {
                    const totalAmountField = document.getElementById('total_amount');
                    const overallTotalAmountField = document.getElementById('overall_total_amount');
                    const amountFields = document.querySelectorAll('input[name="amount[]"]');

                    const gstStatusField = document.getElementById('gst_stat'); // GST status field
                    const gstPercentField = document.getElementById('gst_percent'); // GST percentage field
                    const gst_valueField = document.getElementById('gst_value'); // GST value field

                    const discountPercentField = document.getElementById('discount_percent'); // Discount % field

                    let total = 0;

                    // Sum up the amounts from all fields
                    amountFields.forEach(field => {
                        total += parseFloat(field.value) || 0;
                    });

                    // Calculate discount
                    const discountPercent = parseFloat(discountPercentField.value) || 0;
                    const discountAmount = (total * discountPercent) / 100;

                    const totalAfterDiscount = total - discountAmount;

                    // Update the total amount field (excluding GST, after discount)
                    totalAmountField.value = totalAfterDiscount.toFixed(2);

                    // Check if GST is applicable
                    const gstStatus = gstStatusField.value.trim().toLowerCase() === 'true'; // 'true' or 'false' string
                    const gstPercent = gstStatus ? parseFloat(gstPercentField.value) || 0 : 0;

                    // Calculate GST amount based on discounted total
                    const gstAmount = (totalAfterDiscount * gstPercent) / 100;
                    const finalTotal = gstStatus ? totalAfterDiscount + gstAmount : totalAfterDiscount;

                    // Update GST value field
                    gst_valueField.value = gstAmount.toFixed(2);

                    // Update overall total (after discount + GST)
                    overallTotalAmountField.value = finalTotal.toFixed(2);
                }

                // Attach listeners and initialize
                document.addEventListener('DOMContentLoaded', function () {
                    const amountFields = document.querySelectorAll('input[name="amount[]"]');
                    const gstStatusField = document.getElementById('gst_stat');
                    const gstPercentField = document.getElementById('gst_percent');

                    // Attach listeners to amount fields
                    amountFields.forEach(field => {
                        field.addEventListener('input', updateTotalAmount);
                    });

                    // Attach listeners to GST status and percentage fields
                    gstStatusField.addEventListener('input', updateTotalAmount);
                    gstPercentField.addEventListener('input', updateTotalAmount);

                    // Perform initial calculation
                    updateTotalAmount();
                });

                function toggleSelectAll(checkbox) {
                    const checkboxes = document.querySelectorAll('#itemsTableBody input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = checkbox.checked);
                }

                document.querySelector('.close-button').onclick = function () {
                    document.getElementById('modal').style.display = 'none';
                    window.location.reload();
                };

            </script>

            <style>
                .title-box {
                    display: flex;
                    padding: 5px;
                    background-color: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    margin-bottom: 10px;
                    justify-content: space-between;

                }

                .title-item {
                    display: flex;
                    align-items: center;

                    /* Align title and value on the same row */
                }

                .title-item span {
                    font-size: 18px;
                    font-weight: bold;
                    color: #0fabf3;
                }


                @keyframes open {
                    from {
                        width: 20px;
                        /* Start with 0 width */
                    }

                    to {
                        width: 573px;
                        /* Animate to 473px width */
                    }
                }

                /* Responsive styling for smaller screens */
                @media (max-width: 768px) {
                    .title-box {
                        flex-direction: column;
                        /* Stack items vertically on smaller screens */
                        align-items: flex-start;
                    }

                    .title-item {
                        margin-bottom: 15px;
                        /* Space between stacked items */
                    }
                }
            </style>

            <style>
                /* Basic styling for the table */
                .overhead_table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 0px;
                }

                .overhead_table th,
                .overhead_table td {
                    padding: 5px;
                    text-align: center;
                }

                /* Set specific column widths */
                .overhead_table th:nth-child(1),
                .overhead_table td:nth-child(1) {
                    width: 3%;
                    /* Category column width */
                }

                .overhead_table th:nth-child(2),
                .overhead_table td:nth-child(2) {
                    width: 45%;
                    /* Category column width */
                }

                .overhead_table th:nth-child(3),
                .overhead_table td:nth-child(3) {
                    width: 8%;
                    /* Sub Category column width */
                }

                .overhead_table th:nth-child(4),
                .overhead_table td:nth-child(4) {
                    width: 8%;
                    /* Item Name column width */
                }

                .overhead_table th:nth-child(5),
                .overhead_table td:nth-child(5) {
                    width: 8%;
                    /* Invoice Number column width */
                }

                .overhead_table th:nth-child(6),
                .overhead_table td:nth-child(6) {
                    width: 3%;
                    /* Currency column width */
                }

                th {
                    background-color: #f4f4f4;
                }




                /* Responsive styling */
                @media (max-width: 768px) {

                    table,
                    thead,
                    tbody,
                    th,
                    td,
                    tr {
                        display: block;
                    }

                    th {
                        position: absolute;
                        left: -9999px;
                        top: -9999px;
                    }

                    td {
                        border: none;
                        position: relative;
                        padding-left: 50%;
                        text-align: left;
                    }

                    td:before {
                        position: absolute;
                        top: 10px;
                        left: 10px;
                        width: 45%;
                        padding-right: 10px;
                        white-space: nowrap;
                        font-weight: bold;
                    }

                }

                /* Remove styling from table elements */
                .overhead_table td {
                    margin: 0;
                    padding: 0;
                }
            </style>

            <!-- CSS for Modal -->
            <style>
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background: rgba(163, 59, 59, 0.1);
                    backdrop-filter: blur(10px);
                    justify-content: center;
                }


                .modal-content {
                    background-color: white;
                    margin: auto;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                    width: 80%;
                }

                .close-button {
                    color: #aaa;
                    float: right;
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                }
            </style>

            <div class="table-responsive" style="background-color: white;">

                <table class="table table-main" width="100%" id="projectTable">

                    <thead>
                        <tr>
                            <th class="text-center">
                                <span class="fa-solid fa-eye" style="font-size: 1.25em; color: black;"></span>
                            </th>
                            <th class="text-center">PO NO</th>
                            <th class="text-center">Supplier</th>
                            <th class="text-center">Req On</th>
                            <th class="text-center">RequestBy</th>
                            <th class="text-center">Request No</th>
                            <th class="text-center">Inv Date</th>
                            <th class="text-center">Amount</th>
                            <th class="text-center">GST</th>
                            <th class="text-center">Total</th>
                            <th class="text-center">Terms</th>
                            <th class="text-center">DueDate</th>
                            <th class="text-center">DueDays</th>
                            <th class="text-center">Paid On</th>
                            <th class="text-center">Balance</th>
                            <th class="text-center" style="text-align: center;">Status</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% if grouped_df %}
                        {% for row in grouped_df %}

                        <tr class="mainRow">

                            <td class="text-center view-col">
                                <span class="icon" onclick="openPaymentDetails('{{ row['id'] }}')"
                                    style="cursor: pointer;">
                                    <span class="fa-solid fa-eye"
                                        style="font-size: 1.25em; color: rgb(22, 154, 206);"></span>
                                </span>
                            </td>


                            <td class="text-center po_number1">

                                {{ row['po_number'] }}

                            </td>

                            <td class="text-center supplier_name1">
                                {{ row['supplier_name'][:12] }}{% if row['supplier_name']|length > 15
                                %}...{%
                                endif %}
                            </td>

                            <td class="text-center start-time">{{ row['pay_date'] }}</td>
                            <td class="text-center">{{ row['created_by'] }}</td>

                            <td class="text-center pay_number1">
                                {% if row['invoice_file_name'] %}
                                <a href="{{ url_for('view_pay_req_invoice_file', filename=row['invoice_file_name']) }}"
                                    target="_blank">
                                    {{ row['pay_number'] }}
                                </a>
                                {% else %}
                                <span>{{ row['pay_number'] }}</span>
                                {% endif %}

                            </td>

                            <td class="text-center start-time">{{ row['Invoice_date'] }}</td>
                            <td class="text-center">$ {{ "{:,.2f}".format(row['amount'] ) }}</td>
                            <td class="text-center">$ {{ "{:,.2f}".format(row['gst_value'] ) }}</td>

                            <td class="text-center">$ {{ "{:,.2f}".format(row['amount'] + row['gst_value'] )
                                }}
                            </td>

                            <td class="text-center">
                                {% if row['time_period'] == 'COD' or row['time_period'] == 'Advance' %}
                                {{ row['time_period'] }}
                                {% else %}
                                {{ row['Terms']|int }} {{ row['time_period'] }}
                                {% endif %}

                            </td>

                            <td class="text-center start-time">{{ row['due_date'] }}
                            </td>

                            <td class="text-center">
                                {{ row['due_days']|int }} {{ 'Day' if row['due_days']|int == 1 else 'Days' }}
                            </td>

                            <td class="text-center start-time">
                                {% if row['paid_date'] %}
                                {{ row['paid_date'] }}
                                {% endif %}
                            </td>

                            <td class="text-center">

                                $ {{ "{:,.2f}".format(row['balence']) }}

                            </td>

                            <td class="text-center status status1" style="font-weight: bold; text-align: center;">
                                <span style="color: 
                                {% if row['status'] == 'Pending' %}
                                    brown;
                                {% elif row['status'] == 'Partial' %}
                                    blue;
                                {% elif row['status'] == 'Paid' %}
                                    green;
                                {% elif row['status'] == 'Canceled' %}
                                    red;
                                {% endif %};
                                background-color: 
                                {% if row['status'] == 'Pending' %}
                                    #f2e1d7; /* Light brown background */
                                {% elif row['status'] == 'Partial' %}
                                    #a4acee; /* Light orange background */
                                {% elif row['status'] == 'Paid' %}
                                    #d0f8e3; /* Light green background */
                                {% elif row['status'] == 'Canceled' %}
                                    #f8d7da; /* Light red background */
                                {% endif %};
                                padding: 2px 8px; 
                                border-radius: 8px; 
                                display: inline-block; /* Ensures the span takes up only as much space as needed */
                            ">
                                    {{ row['status'] }}
                                </span>
                            </td>

                        </tr>

                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="15" class="text-center"
                                style="text-align: center; font-size: larger; color: #dc3545;">No Requests available
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>

                </table>

                <script>

                    function formatNumber(number) {
                        return new Intl.NumberFormat('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }).format(number);
                    }

                    function formatDate(dateString) {
                        const date = new Date(dateString);
                        const day = String(date.getDate()).padStart(2, '0');  // Pad with zero if single digit
                        const month = String(date.getMonth() + 1).padStart(2, '0');  // Months are 0-indexed, so add 1
                        const year = String(date.getFullYear()).slice(-2);  // Get last two digits of the year
                        return `${day}/${month}/${year}`;
                    }

                    function openPaymentDetails(payNumber) {
                        fetch(`/get_payment_details?pay_number=${payNumber}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // console.log(".....data..............", data);
                                    document.getElementById('modalPayNumber').textContent = data.payment.pay_number;
                                    let projectName = data.payment.project_name;
                                    document.getElementById('modalProject').textContent = projectName.length > 10 ? projectName.slice(0, 15) + '...' : projectName;
                                    document.getElementById('modalSupplier').textContent = data.payment.supplier_name;
                                    document.getElementById('modalAmount').textContent = `$ ${formatNumber((data.payment.amount ?? 0).toFixed(2))}`;
                                    document.getElementById('modalGST').textContent = `$ ${formatNumber((data.payment.gst_value ?? 0).toFixed(2))}`;
                                    document.getElementById('modalTotal').textContent = `$ ${formatNumber((data.payment.overall_total_amount ?? 0).toFixed(2))}`;
                                    document.getElementById('modalInvoiceDate').textContent = formatDate(data.payment.Invoice_date);
                                    document.getElementById('modalStatus').textContent = data.payment.status;
                                    document.getElementById('modalComments').textContent = data.payment.comments;

                                    document.getElementById('modalpay_date').textContent = formatDate(data.payment.pay_date) || '';
                                    document.getElementById('modalproj_no').textContent = data.payment.proj_no || '';
                                    document.getElementById('modalproj_Inv_no').textContent = data.payment.invoice_no || '';
                                    document.getElementById('modalpo_number').textContent = data.payment.po_number || '';
                                    document.getElementById('modalcreated_by').textContent = data.payment.created_by || '';
                                    let termsText = (data.payment.Terms && data.payment.Terms !== 'none') ? data.payment.Terms : '';
                                    let timePeriodText = data.payment.time_period || '';
                                    document.getElementById('modalTerms').textContent = `${termsText}  ${timePeriodText}`;
                                    let itemsTable = document.getElementById('modalItemsTable');
                                    itemsTable.innerHTML = "";
                                    data.items.forEach(item => {
                                        let row = `<tr>
                                <td style="width: 15%; text-align: left; " >${item.Part_No}</td>
                                <td style="width: 55%; text-align: left; " >${item.item}</td>
                                <td style="width: 10%; text-align: left; " >${formatNumber(item.req_quantity.toFixed(2))}</td>
                                <td style="width: 10%; text-align: right; " >$ ${formatNumber(item.Unit_Price.toFixed(2))}</td>
                                <td style="width: 10%; text-align: right; " >$ ${formatNumber(item.req_total.toFixed(2))}</td>
                            </tr>`;
                                        itemsTable.innerHTML += row;
                                    });
                                    let historyitemsTable = document.getElementById('modalHostoryItemsTable1');
                                    historyitemsTable.innerHTML = ""; // Clear existing table content
                                    let totalAmount = 0; // Initialize total amount
                                    data.history_items.forEach(history_item => {
                                        let amount = history_item.amount ? parseFloat(history_item.amount) : 0;
                                        totalAmount += amount; // Accumulate total

                                        let row = `<tr>
                                    <td style="width: 15%; text-align: left;">${formatDate(history_item.pay_date)}</td>
                                    <td style="width: 55%; text-align: left;">${history_item.paid_by}</td>
                                    <td style="width: 10%; text-align: right;">$ ${formatNumber(amount.toFixed(2))}</td>
                                </tr>`;

                                        historyitemsTable.innerHTML += row;
                                    });
                                    let historyHeading = document.getElementById('paymentHistoryHeading');
                                    if (historyHeading) {
                                        historyHeading.innerHTML = `Payment History <h5 style="display: inline; font-weight: normal;">(Total Paid: $ ${formatNumber(totalAmount.toFixed(2))})</h5>`;
                                    }
                                    // Show the modal
                                    document.getElementById('paymentModal').style.display = 'block';
                                } else {
                                    alert('Payment details not found!');
                                }
                            })
                            .catch(error => console.error('Error fetching payment details:', error));
                    }

                    function closeModal() {
                        document.getElementById('paymentModal').style.display = 'none';
                    }

                </script>

            </div>

        </div>



        <div id="paymentModal" class="modal">

            <div class="modal-content">

                <div class="button-container1">

                    <h2>Payment Details (<span id="modalPayNumber"></span>)
                    </h2>
                    <span class="close" onclick="closeModal()">&times;</span>

                </div>

                <div class="container">

                    <div class="invoice-header">

                        <div class="invoice-row">
                            <p><strong>Invoice No</strong></p> <span id="modalproj_Inv_no"></span>
                        </div>
                        <div class="invoice-row">
                            <p><strong>Project</strong></p> <span id="modalproj_no"></span>
                        </div>
                        <div class="invoice-row">
                            <p><strong>Project Name</strong></p> <span id="modalProject"></span>
                        </div>
                        <div class="invoice-row">
                            <p><strong>PO Number</strong></p> <span id="modalpo_number"></span>
                        </div>


                    </div>

                    <div class="invoice-header">
                        <div class="invoice-row">
                            <p><strong>Supplier</strong></p> <span id="modalSupplier"></span>
                        </div>

                        <div class="invoice-row">
                            <p><strong>Requst Date</strong></p> <span id="modalpay_date"></span>
                        </div>
                        <div class="invoice-row">
                            <p><strong>Requested By</strong></p> <span id="modalcreated_by"></span>
                        </div>
                        <div class="invoice-row">
                            <p><strong>Invoice Date</strong></p> <span id="modalInvoiceDate"></span>
                        </div>

                    </div>

                    <div class="invoice-header">

                        <div class="invoice-row">
                            <p><strong>Terms</strong></p> <span id="modalTerms"></span>
                        </div>

                        <div class="invoice-row">
                            <p><strong>Amount</strong></p> <span id="modalAmount"></span>
                        </div>

                        <div class="invoice-row">
                            <p><strong>GST</strong></p> <span id="modalGST"></span>
                        </div>

                        <div class="invoice-row">
                            <p><strong>Total</strong></p> <span id="modalTotal"></span>
                        </div>

                    </div>

                    <div class="invoice-header">

                        <div class="invoice-row">
                            <p><strong>Status</strong></p> <span id="modalStatus"></span>
                        </div>

                        <div class="invoice-row">
                            <p><strong>Comments</strong></p> <span id="modalComments"></span>
                        </div>

                    </div>

                </div>

                <div class="container">

                    <div class="table-responsive1">

                        <table class="table table-main" width="100%">

                            <thead>
                                <tr>
                                    <th style="text-align: left; width: 15%;">Part No</th>
                                    <th style="text-align: left; width: 55%;">Item</th>
                                    <th style="text-align: left; width: 10%;">Quantity</th>
                                    <th style="text-align: right; width: 10%;">Unit Price</th>
                                    <th style="text-align: right; width: 10%;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="modalItemsTable">
                                <!-- Items will be inserted here -->
                            </tbody>

                        </table>

                    </div>

                </div>

                <div class="button-container1">

                    <h2 id="paymentHistoryHeading">Payment History</h2>

                </div>

                <div class="container">

                    <div class="table-responsive2">

                        <table class="table table-main" width="50%">

                            <thead>

                                <tr>
                                    <th style="text-align: left;">Paid On</th>
                                    <th style="text-align: left;">Paid By</th>
                                    <th style="text-align: left;">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="modalHostoryItemsTable1">

                            </tbody>

                        </table>

                    </div>

                </div>

            </div>

        </div>

        <style>
            .table-responsive1 {
                width: 100%;
                overflow: auto;
                max-height: 450px;
                border-radius: 10px;
                border: 1px solid #ddd;
            }

            .table-responsive2 {
                width: 100%;
                overflow: auto;
                max-height: 120px;
                border-radius: 10px;
                border: 1px solid #ddd;
            }

            .table-main {
                width: 100%;
                border-collapse: collapse;
            }

            .table-main thead {
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
            }

            .invoice-header {
                flex: 1;
                background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                color: #004d40;
                transition: transform 0.2s ease-in-out;
            }

            .invoice-header:hover {
                transform: scale(1.02);
            }


            .invoice-row {
                display: grid;
                grid-template-columns: 130px auto;
                /* First column for labels, second for values */
                gap: 10px;
                align-items: center;
                padding: 5px 0;
            }

            .invoice-row p {
                margin: 0;
                font-weight: bold;
                text-align: left;
            }

            .invoice-row span {
                text-align: left;
            }


            .invice_header {
                width: 100%;
                padding: 10px;

            }

            .button-container1 {
                display: flex;
                flex: 1;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                margin-top: 10px;
                gap: 10px;
            }

            .button-container2 {
                display: flex;
                flex: 1;
                justify-content: center;
                align-items: center;
                width: 100%;
                margin-top: 10px;
                gap: 10px;
            }


            .title-box {
                display: flex;
                padding: 5px;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 10px;
                justify-content: space-between;

            }

            .title-item {
                display: flex;
                align-items: center;

                /* Align title and value on the same row */
            }

            .title-item span {
                font-size: 18px;
                font-weight: bold;
                color: #004b5d;
            }


            @keyframes open {
                from {
                    width: 20px;
                    /* Start with 0 width */
                }

                to {
                    width: 573px;
                    /* Animate to 473px width */
                }
            }

            /* Responsive styling for smaller screens */
            @media (max-width: 768px) {
                .title-box {
                    flex-direction: column;
                    /* Stack items vertically on smaller screens */
                    align-items: flex-start;
                }

                .title-item {
                    margin-bottom: 15px;
                    /* Space between stacked items */
                }
            }
        </style>

        <style>
            .form-label {
                display: block;
            }

            .form-control {
                width: 100%;
                padding: 5px 6px;
                margin-bottom: 10px;
                box-sizing: border-box;
                border: 1px solid #ced4da;
                border-radius: 6px;
                font-size: 1rem;
                line-height: 1.0;
                color: #495057;
                background-color: #fff;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.075);
                transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            }

            .form-control:focus {
                color: #495057;
                background-color: #fff;
                border-color: chartreuse;
                outline: 0;
                box-shadow: 0 0 0 0.05rem rgba(0, 123, 255, 0.25);
            }

            .form-control::placeholder {
                color: #6c757d;
                opacity: 1;
            }

            .form-control:disabled,
            .form-control[readonly] {
                background-color: #e9ecef;
                opacity: 1;
            }

            .form-control:hover {
                border-color: #b0b4b8;
            }

            .form-control::placeholder {
                text-align: center;
            }


            .flex-item-full-width {
                flex: 1;
            }

            .flex-row {
                display: flex;
                flex-direction: row;
                gap: 15px;
                /* Optional: add spacing between flex items within .flex-row */
            }

            .flex-item {
                flex: 1;
                /* Ensure flex items grow equally */
            }

            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6));
                backdrop-filter: blur(4px);
                animation: fadeIn 0.3s ease-in-out;
            }

            /* Optional animation for smoother appearance */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }


            .modal-content {
                background-color: white;
                margin: 1% auto;
                padding: 20px;
                border-radius: 10px;
                width: 80%;
                border: 2px solid #ccc;
                backdrop-filter: blur(4px);
                animation: fadeIn 0.3s ease-in-out;

            }

            .close {
                float: right;
                font-size: 24px;
                cursor: pointer;
            }
        </style>

        <style>
            /* ... (Your existing CSS styles) ... */
            .status-bar {
                width: 20%;
                /* Make the bar 100% width */
                height: 27px;
                background-color: #eee;
                border-radius: 5px;
                display: flex;
                cursor: pointer;
            }

            .status-segment {
                height: 100%;
                border-radius: 4px;
                text-align: center;
                line-height: 20px;
                color: white;
                font-size: smaller;
                padding: 0 10px;
                display: flex;
                /* Use flexbox for centering */
                align-items: center;
                /* Vertically center content */
                justify-content: center;
                /* Horizontally center content */
            }

            /* ... (Rest of your CSS styles) ... */

            .status-segment span {
                /* Style the label inside the segment */
                display: inline-block;
                /* Make the label respect padding and margins */
            }

            .pending {
                background-color: rgb(161, 62, 62);
            }

            .partial {
                background-color: #6d76ce;
            }

            .paid {
                background-color: rgb(132, 209, 132);
            }

            .canceled {
                background-color: red;
            }

            /* ... (Your existing CSS styles) ... */
        </style>


    </div>

    </div>

    <style>
        .mat_rec_table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0px;
        }

        .mat_rec_table th,
        .mat_rec_table td {
            padding: 5px;
            text-align: center;
        }

        .mat_rec_table td {
            margin: 0;
            padding: 0;
        }
    </style>

    <style>
        .records {
            width: 100%;
            overflow-x: auto;
        }

        .record-header {
            width: 100%;
            padding: 10px;
        }


        .double-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(6, 6, 6, 0.1);
            box-sizing: border-box;
            /* Ensure padding and border are included in width */
        }


        .form-label {
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 6px;
            margin-bottom: 0px;
            box-sizing: border-box;
        }

        .flex-item-full-width {
            flex: 1;
        }

        .flex-row {
            display: flex;
            flex-direction: row;
            gap: 15px;
            /* Optional: add spacing between flex items within .flex-row */
        }

        .flex-item {
            margin-top: 5px;
            flex: 1;
            /* Ensure flex items grow equally */
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .btn4 {
                font-size: 14px;
                padding: 8px 12px;
                /* Adjusted padding for smaller screens */
            }

            .row1 {
                flex-direction: column;
                align-items: center;
            }
        }

        @media (max-width: 480px) {
            .btn4 {
                font-size: 12px;
                padding: 6px 10px;
                /* Further adjusted padding */
            }
        }

        @media (max-width: 768px) {
            .flex-item {
                flex: 1 1 100%;
            }
        }

        @media (max-width: 768px) {
            .double-container {
                width: 100%;
            }
        }
    </style>

    <script>
        // Function to format a date string as 'day/month/year' with digits only
        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                // Return an empty string for invalid dates
                return "";
            }

            const day = date.getDate().toString().padStart(2, "0");
            const month = (date.getMonth() + 1)
                .toString()
                .padStart(2, "0"); // Adding 1 because months are zero-based
            const year = date.getFullYear().toString().slice(-2);

            return `${day}-${month}-${year}`;
        }

        // Call the formatDate function for each date element when the page loads
        document.addEventListener("DOMContentLoaded", function () {
            const start_time_elements =
                document.querySelectorAll(".start-time");
            start_time_elements.forEach(function (element) {
                element.textContent = formatDate(element.textContent);
            });


        });
    </script>

</body>

</html>