<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <title>Centroid Engineering Solutions</title>
    <link rel="icon" type="image/jpeg" href="static/ces_logo.png">
    <link rel="stylesheet" href="../static/res_style.css">
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <!-- <script src="https://kit.fontawesome.com/f8e1a90484.js" crossorigin="anonymous"></script> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

</head>

<body>

    <input type="checkbox" id="menu-toggle">

    <div class="sidebar">

        <div class="side-header">
            <h3>C<span>entroid</span></h3>
        </div>

        <div class="side-content">

            <div class="profile">
                <div class="profile-img bg-img" style="background-image: url(../static/1.png)"></div>
                <h4>{{user['name']}}</h4>
                <small>{{department_code}}</small>
            </div>

            <div class="side-menu">
                <ul>

                    {% if department_code == 1000 %}
                    <li>
                        <a href="/admin">
                            <span class="fa-solid fa-user-tie"></span>
                            <small>Admin</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if user_access['Accounts'] == 'On' %}
                    <li>
                        <a href="/accounts">
                            <span class="fa-solid fa-file-invoice-dollar"></span>
                            <small>Accounts</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleEnquiry'] == 'On' %}
                    <li>
                        <a href="/admin_enquiry">
                            <span class="fa-solid fa-handshake"></span>
                            <small>Leads</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleHR'] == 'On' %}
                    <li>
                        <a href="/hr">
                            <span class="fa-solid fa-user-plus"></span>
                            <small>HR</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['togglePlanner'] == 'On' %}
                    <li>
                        <a href="/planner">
                            <span class="fa-solid fa-calendar-check"></span>
                            <small>Planner</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleProfile'] == 'On' %}
                    <li>
                        <a href="/profile">
                            <span class="fa-solid fa-user"></span>
                            <small>Profile</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleProjects'] == 'On' %}
                    <li>
                        <a href="/projects" class="active">
                            <span class="fa-solid fa-chart-simple"></span>
                            <small>Project</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['togglePurchase'] == 'On' %}
                    <li>
                        <a href="/purchase">
                            <span class="fa-solid fa-cart-shopping"></span>
                            <small>Purchase</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if user_access['toggleResources'] == 'On' %}
                    <li>
                        <a href="/resources">
                            <span class="fa-solid fa-recycle"></span>
                            <small>Resources</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if department_code == 1000 %}
                    <li>
                        <a href="/settings">
                            <span class="fa-solid fa-gears"></span>
                            <small>Settings</small>
                        </a>
                    </li>
                    {% endif %}

                    <li>
                        <a href="{{ url_for('logout') }}">
                            <span class="fa-solid fa-right-from-bracket"></span>
                            <small>Log Out</small>
                        </a>
                    </li>
                </ul>
            </div>

        </div>

    </div>

    <div class="main-content">

        <div class="page-content" style="background-color: white;">

            <div class="page-header" style="background-color: white;">

                <nav class="navbar1">

                    <ul id="menuList1" class="navitems1">

                        {% if user_access['toggleDashboard'] == 'On' %}
                        <li>
                            <a href="{{ url_for('projects') }}" class="link">
                                <i class="fa-solid fa-chart-line" style="margin-right: 5px;"></i> Dashboard
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleProjectStatus'] == 'On' %}
                        <li>
                            <a href="{{ url_for('prj_status') }}" class="link">
                                <i class="fa-solid fa-clipboard-check" style="margin-right: 5px;"></i> Status
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleHoursEdit'] == 'On' %}
                        <li class="active">
                            <a href="{{ url_for('hours_edit') }}" class="link">
                                <i class="fa-solid fa-clock-rotate-left" style="margin-right: 5px;"></i> Hours Edit
                            </a>
                        </li>
                        {% endif %}

                        {% if user_access['toggleMaterialReceipt'] == 'On' %}
                        <li><a href="{{ url_for('Material_Receipt') }}" class="link"><i
                                    class="fa-solid fa-industry"></i>
                                Material Receipt</a></li>
                        {% endif %}

                        {% if user_access['toggleHoursView'] == 'On' %}
                        <li>
                            <a href="{{ url_for('hrs_view') }}" class="link">
                                <i class="fa-solid fa-clock" style="margin-right: 5px;"></i> Hours View
                            </a>
                        </li>
                        {% endif %}

                    </ul>

                    <div class="menu-icon">
                        <i class="fa-solid fa-bars" onclick="toggleMenu()"></i>
                    </div>

                    <script>
                        let menuList1 = document.getElementById("menuList1");
                        menuList1.style.maxHeight = "0px";

                        function toggleMenu1() {
                            if (menuList1.style.maxHeight == "0px") {
                                menuList1.style.maxHeight = "300px";
                            } else {
                                menuList1.style.maxHeight = "0px";
                            }
                        }
                    </script>

                </nav>

                <div class="line"></div>

            </div>

            <form method="POST">

                <div class="search_container">

                    <div class="row-inside" style="padding: 0px;">

                        <div class="form-group" style="display: inline-block; margin-right: 10px;">
                            <select class="form-control" id="update_employee_id" name="employee_id" required>
                                <option value="" {% if not employee_id %}selected{% endif %}>Select Employee
                                </option>
                                {% for username in usernames %}
                                <option value="{{ username }}" {% if username==employee_id %}selected{% endif %}>{{
                                    username }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group" style="display: inline-block; margin-right: 10px;">
                            <select class="form-control" id="month" name="month" required>
                                <option value="">Select Month</option>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>

                        <script>
                            // Get current month (0-based index, so add 1)
                            const currentMonth = new Date().getMonth() + 1;
                            // Format the month to be 2 digits (01, 02, ...)
                            const formattedMonth = currentMonth < 10 ? '0' + currentMonth : currentMonth;

                            // Set the selected option
                            document.getElementById('month').value = formattedMonth;
                        </script>


                        <div class="form-group" style="display: inline-block; margin-right: 10px;">
                            <select class="form-control" id="year" name="year" required>
                                <option value="">Select Year</option>
                                {% for year in range(current_year - 9, current_year + 1) %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" id="view_data_button" class="custom-btn btn-2">
                            Get Data
                        </button>
                    </div>

                </div>

                <style>
                    .search_container {

                        width: 100%;
                        padding: 10px;
                    }
                </style>


            </form>

            <form id="updateForm" method="POST">

                <div class="table-responsive" style="background-color: white;">

                    <div class="flex-item">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                        <div class="alert-container" id="flash-message-container">
                            {% for category, message in messages %}
                            {% if category == 'update_hr' %}
                            <div class="alert alert-success">{{ message }}</div>
                            {% elif category == 'update_hr1' %}
                            <div class="alert alert-danger">{{ message }}</div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>

                    <script>
                        // Check if there are any flash messages
                        const flashContainer = document.getElementById('flash-message-container');
                        if (flashContainer) {
                            // Set a timeout to hide the flash message after 5 seconds
                            setTimeout(() => {
                                flashContainer.style.display = 'none';
                            }, 5000); // 5000 milliseconds = 5 seconds
                        }
                    </script>


                    <table class="table" width="100%" id="project_dynamicTable">
                        <thead>
                            <tr>
                                <th style="display: none;">entryID</th>
                                <th style="width: 5%;">S/N</th>
                                <th style="width: 5%;">Proj ID</th>
                                <th style="width: 5%;">Code</th>
                                <th style="width: 8%;">Date</th>
                                <th style="width: 30%; text-align: left;">Project Name</th>
                                <th style="width: 20%; text-align: left;">Client</th>
                                <th style="width: 5%; text-align: center;">Standard</th>
                                <th style="width: 5%; text-align: center;">X 1.5</th>
                                <th style="width: 5%; text-align: center;">X 2.0</th>
                                <th style="width: 8%;">Total Hr</th>
                                <th style="width: 3%;">
                                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"
                                        class="small-checkbox">
                                </th>
                                <style>
                                    .small-checkbox {
                                        width: 15px;
                                        height: 15px;
                                    }
                                </style>

                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="13" class="text-center"
                                    style="text-align: center; font-size: larger; color: #dc3545;">Select Employee to
                                    Edit hours</td>
                            </tr>
                        </tbody>
                    </table>

                </div>

                <div class="button-container">
                    <button type="button" id="updateButton" class="custom-btn btn-2">Update Hours</button>
                </div>
            </form>

            <script>
                // Function to handle validation and total calculation
                function validateHours() {
                    const row = this.closest('tr');
                    if (!row) {
                        console.error("Error: Parent row not found.");
                        return;
                    }

                    const hoursWorkedInput = row.querySelector('[name="standered"]');
                    const overtime1_5Input = row.querySelector('[name="x_1_5"]');
                    const overtime2_0Input = row.querySelector('[name="x_2_0"]');

                    if (!hoursWorkedInput || !overtime1_5Input || !overtime2_0Input) {
                        console.error("Error: Required input fields not found in the row.");
                        return;
                    }

                    const hoursWorked = parseFloat(hoursWorkedInput.value) || 0;
                    const overtime1_5 = parseFloat(overtime1_5Input.value) || 0;
                    const overtime2_0 = parseFloat(overtime2_0Input.value) || 0;

                    const totalHours = hoursWorked + overtime1_5 + overtime2_0;

                    if (totalHours > 24) {
                        alert("Total hours cannot exceed 24.");
                        this.value = ''; // Clear the current input value
                    } else {
                        const totalHoursCell = row.querySelector('[name="totalhr"]');
                        if (totalHoursCell) {
                            totalHoursCell.value = totalHours.toFixed(2); // Update total
                        } else {
                            console.error("Error: Total hours cell not found in the row.");
                        }
                    }
                }

                // Attach event listeners to all rows after fetching data
                document.getElementById('view_data_button').addEventListener('click', function (event) {
                    event.preventDefault();

                    const employeeId = document.getElementById('update_employee_id').value;
                    const month = document.getElementById('month').value;
                    const year = document.getElementById('year').value;

                    if (!employeeId || !month || !year) {
                        alert('Please select Employee, Month, and Year.');
                        return;
                    }

                    fetch('/fetch_working_hours', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ employee_id: employeeId, month: month, year: year })
                    })
                        .then(response => response.json())
                        .then(data => {
                            const tbody = document.querySelector('#project_dynamicTable tbody');
                            tbody.innerHTML = ''; // Clear the table

                            data.forEach((row, index) => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                <td>${index + 1}</td> <!-- Serial Number Column -->
                                <td name="entryID" style="display: none;">${row.entryID}</td>
                                <td style="display: none;"><input  name="formatted_date" type="date" value="${row.formatted_date}"/></td>
                                <td style="display: none;"><input  name="employeeID" type="text" value="${row.employeeID}"/></td>
                                <td>${row.projectID}</td>
                                <td>${row.departmentID}</td>
                                <td>${row.workingDate}</td>
                                <td>${row.project_name}</td>
                                <td>${row.client}</td>
                                <td><input name="standered" style="background-color: #e0f7fa;" type="number" value="${row.hoursWorked}" class="form-control1 hours-input" /></td>
                                <td><input name="x_1_5" style="background-color: #f3e5f5;" type="number" value="${row.overtime_1_5}" class="form-control1 hours-input" /></td>
                                <td><input name="x_2_0" style="background-color: #ffcc80;" type="number" value="${row.overtime_2_0}" class="form-control1 hours-input" /></td>
                                <td><input name="totalhr" style="background-color: #c8e6c9;" type="number" value="${row.totalhours}" class="form-control1 total-hours" readonly /></td>
                                <td><input type="checkbox" class="small-checkbox" name="selected_items[]" value="${row.entryID}"></td>
                            `;
                                tbody.appendChild(tr);
                            });

                            // Attach event listeners to dynamically added inputs
                            const hourInputs = document.querySelectorAll('.hours-input');
                            hourInputs.forEach(input => {
                                input.addEventListener('input', validateHours);
                            });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to fetch data.');
                        });
                });

                // Function to handle updating selected rows
                document.querySelector('#updateButton').addEventListener('click', function (event) {
                    event.preventDefault();  // Prevent default form submission

                    // Get all selected checkboxes
                    const selectedCheckboxes = document.querySelectorAll('input[name="selected_items[]"]:checked');
                    if (selectedCheckboxes.length === 0) {
                        alert("Please select at least one row to update.");
                        return;
                    }

                    const updatedRows = [];

                    selectedCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        const entryID = row.querySelector('[name="entryID"]').textContent; // Get entryID from hidden td
                        const hoursWorked = row.querySelector('[name="standered"]').value;
                        const overtime1_5 = row.querySelector('[name="x_1_5"]').value;
                        const overtime2_0 = row.querySelector('[name="x_2_0"]').value;
                        const totalhr = row.querySelector('[name="totalhr"]').value;
                        const employee = row.querySelector('[name="employeeID"] ').value;
                        const formatted_date = row.querySelector('[name="formatted_date"] ').value;

                        // Collect data for the updated rows
                        updatedRows.push({
                            entryID,
                            hoursWorked,
                            overtime1_5,
                            overtime2_0,
                            totalhr,
                            employee,
                            formatted_date
                        });
                    });

                    // Send updated data to the server using fetch
                    fetch('/update_working_hours', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ updatedRows })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert("Hours updated successfully!");
                            // Optionally, refresh the table or handle the response here
                            window.location.reload();

                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to update working hours.');
                        });
                });

            </script>

            <script>

                function toggleSelectAll(checkbox) {
                    // Select all checkboxes within the table body of the project_dynamicTable
                    const checkboxes = document.querySelectorAll('#project_dynamicTable tbody input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = checkbox.checked);
                }

            </script>


        </div>

    </div>

    <style>
        th {
            background-color: #f4f4f4;
        }

        input {
            width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            height: 30px;
            border: none;
        }

        .add-row-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-row-btn:hover {
            background-color: #45a049;
        }

        /* Responsive styling */
        @media (max-width: 768px) {

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            th {
                position: absolute;
                left: -9999px;
                top: -9999px;
            }

            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: left;
            }

            td:before {
                position: absolute;
                top: 10px;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
            }

        }

        /* Remove styling from table elements */
        .overhead_table td {
            margin: 0;
            padding: 0;
        }

        .button-container1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 10px;
            gap: 10px;
        }
    </style>

    <style>
        .form-control {
            font-size: 16px;
            border-radius: 10px;
        }


        .form-control {
            width: 100%;
            padding: 6px;
            margin-bottom: 0px;
            box-sizing: border-box;
        }


        .form-control1 {
            font-size: 16px;
            text-align: center;
            border-radius: 10px;
        }

        .form-control1 {
            width: 100%;
            padding: 6px;
            margin-bottom: 0px;
            box-sizing: border-box;
        }


        .form-group {
            display: inline-block;
            margin-right: 0px;
            flex-grow: 1;
            max-width: 15%;
        }

        select {
            width: 70%;
        }


        .btn {
            background-color: rgb(0, 75, 93);
            color: whitesmoke;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 10px;
        }

        .row-inside {
            display: flex;
            justify-content: center;
            /* Center items horizontally */
            align-items: center;
            /* Align items vertically */
            gap: 10px;
            /* Adds a 10px gap between items */
        }
    </style>

    <script>
        // Get the current date
        var currentDate = new Date();


        var currentYear = currentDate.getFullYear();

        // Set the default values for the month and year select fields
        // document.getElementById('month').value = currentMonth;
        document.getElementById('year').value = currentYear;
    </script>

</body>

</html>