<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <title>Centroid Engineering Solutions</title>
    <link rel="icon" type="image/jpeg" href="static/ces_logo.png">
    <link rel="stylesheet" href="../static/res_style.css">
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <!-- <script src="https://kit.fontawesome.com/f8e1a90484.js" crossorigin="anonymous"></script> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

</head>

<body>

    <input type="checkbox" id="menu-toggle">

    <div class="sidebar">

        <div class="side-header">
            <h3>C<span>entroid</span></h3>
        </div>

        <div class="side-content">

            <div class="profile">
                <div class="profile-img bg-img" style="background-image: url(../static/1.png)"></div>
                <h4>{{user['name']}}</h4>
                <small>{{department_code}}</small>
            </div>

            <div class="side-menu">
                <ul>

                    {% if department_code == 1000 %}
                    <li>
                        <a href="/admin">
                            <span class="fa-solid fa-user-tie"></span>
                            <small>Admin</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if user_access['Accounts'] == 'On' %}
                    <li>
                        <a href="/accounts" class="active">
                            <span class="fa-solid fa-file-invoice-dollar"></span>
                            <small>Accounts</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleEnquiry'] == 'On' %}
                    <li>
                        <a href="/admin_enquiry">
                            <span class="fa-solid fa-handshake"></span>
                            <small>Leads</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleHR'] == 'On' %}
                    <li>
                        <a href="/hr">
                            <span class="fa-solid fa-user-plus"></span>
                            <small>HR</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['togglePlanner'] == 'On' %}
                    <li>
                        <a href="/planner">
                            <span class="fa-solid fa-calendar-check"></span>
                            <small>Planner</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleProfile'] == 'On' %}
                    <li>
                        <a href="/profile">
                            <span class="fa-solid fa-user"></span>
                            <small>Profile</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['toggleProjects'] == 'On' %}
                    <li>
                        <a href="/projects">
                            <span class="fa-solid fa-chart-simple"></span>
                            <small>Project</small>
                        </a>
                    </li>
                    {% endif %}
                    {% if user_access['togglePurchase'] == 'On' %}
                    <li>
                        <a href="/purchase">
                            <span class="fa-solid fa-cart-shopping"></span>
                            <small>Purchase</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if user_access['toggleResources'] == 'On' %}
                    <li>
                        <a href="/resources">
                            <span class="fa-solid fa-recycle"></span>
                            <small>Resources</small>
                        </a>
                    </li>
                    {% endif %}

                    {% if department_code == 1000 %}
                    <li>
                        <a href="/settings">
                            <span class="fa-solid fa-gears"></span>
                            <small>Settings</small>
                        </a>
                    </li>
                    {% endif %}

                    <li>
                        <a href="{{ url_for('logout') }}">
                            <span class="fa-solid fa-right-from-bracket"></span>
                            <small>Log Out</small>
                        </a>
                    </li>
                </ul>
            </div>

        </div>

    </div>

    <div class="main-content">

        <div id="pageLoader">
            <div class="loader"></div>

            <script>
                window.addEventListener("load", function () {
                    document.getElementById("pageLoader").style.display = "none";
                });
            </script>

            <style>
                #pageLoader {
                    position: fixed;
                    width: 100vw;
                    height: 100vh;
                    background: white;
                    z-index: 9999;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }

                .loader {
                    border: 8px solid #f3f3f3;
                    /* Light grey */
                    border-top: 8px solid #3498db;
                    /* Blue */
                    border-radius: 50%;
                    width: 60px;
                    height: 60px;
                    animation: spin 1s linear infinite;
                }

                @keyframes spin {
                    0% {
                        transform: rotate(0deg);
                    }

                    100% {
                        transform: rotate(360deg);
                    }
                }
            </style>
        </div>
        <div class="page-content" style="background-color: white;">

            <div class="page-header" style="background-color: white;">

                <nav class="navbar1">

                    <ul id="menuList1" class="navitems1">

                        {% if user_access['toggleClient'] == 'On' %}
                        <li>
                            <a href="{{ url_for('client_details') }}" class="link">
                                <i class="fa-solid fa-handshake-simple" style="margin-right: 5px;"></i> Clients
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['toggleSuppliers'] == 'On' %}
                        <li>
                            <a href="{{ url_for('vendor') }}" class="link">
                                <i class="fa-sharp fa-solid fa-store" style="margin-right: 5px;"></i> Suppliers
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['toggleExpenses'] == 'On' %}
                        <li class="active">
                            <a href="{{ url_for('ac_pay_req') }}" class="link">
                                <i class="fa-solid fa-check-circle" style="margin-right: 5px;"></i> Expenses
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['toggleInvoice'] == 'On' %}
                        <li>
                            <a href="{{ url_for('reports') }}" class="link">
                                <i class="fa-solid fa-file-invoice" style="margin-right: 5px;"></i>Reports
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['toggleInvoice'] == 'On' %}
                        <li>
                            <a href="{{ url_for('invoice') }}" class="link">
                                <i class="fa-solid fa-file-invoice" style="margin-right: 5px;"></i>Invoice
                            </a>
                        </li>
                        {% endif %}
                        {% if user_access['toggleOverHeadPayReq'] == 'On' %}
                        <li>
                            <a href="{{ url_for('add_expense') }}" class="link">
                                <i class="fa-solid fa-money-bill-wave" style="margin-right: 5px;"></i> Add Expenses
                            </a>
                        </li>
                        {% endif %}

                    </ul>

                    <div class="menu-icon">
                        <i class="fa-solid fa-bars" onclick="toggleMenu()"></i>
                    </div>

                    <script>
                        let menuList1 = document.getElementById("menuList1");
                        menuList1.style.maxHeight = "0px";

                        function toggleMenu1() {
                            if (menuList1.style.maxHeight == "0px") {
                                menuList1.style.maxHeight = "300px";
                            } else {
                                menuList1.style.maxHeight = "0px";
                            }
                        }
                    </script>


                </nav>

                <div class="line"></div>

            </div>

            <div class="search_container">
                <div class="pending-section">
                    <h3>Pending</h3>
                    <span class="span_tag">
                        Amount : <span id="pendingAmount">$ 0.00</span>
                    </span>
                    <span class="span_tag">
                        GST : <span id="pendingGST">$ 0.00</span>
                    </span>
                    <span class="span_tag">
                        Total : <span id="pendingTotal">$ 0.00</span>
                    </span>
                </div>

                <input type="text" id="searchInput" placeholder="Search.......🔍" onkeyup="filterTable()">

                <div class="paid-section">
                    <h3>Paid</h3>
                    <span class="span_tag">
                        Amount : <span id="paidAmount">$ 0.00</span>
                    </span>
                    <span class="span_tag">
                        GST : <span id="paidGST">$ 0.00</span>
                    </span>
                    <span class="span_tag">
                        Total : <span id="paidTotal">$ 0.00</span>
                    </span>
                </div>
            </div>

            <style>
                .search_container {
                    display: flex;
                    align-items: center;
                    gap: 20px;
                    flex-wrap: wrap;
                    padding: 5px;
                    border-radius: 10px;
                    background-color: white;
                }

                .pending-section {
                    background-color: #eaf2f8;
                    border-left: 5px solid #2980b9;
                    padding: 5px 7px;
                    border-radius: 8px;
                    color: #004274;
                }

                #searchInput {
                    padding: 8px 12px;
                    border-radius: 5px;
                    border: 1px solid #ccc;
                    flex: 1;
                    min-width: 200px;
                }

                .pending-section h3 {
                    margin-bottom: 5px;
                    color: #004274;
                }

                .pending-section .span_tag {
                    display: inline-block;
                    margin-right: 15px;
                    color: #2980b9;
                }

                .paid-section {
                    background-color: #eafaf1;
                    border-left: 5px solid #27ae60;
                    padding: 10px 15px;
                    border-radius: 8px;
                    color: #145a32;
                }

                .paid-section h3 {
                    margin-bottom: 5px;
                    color: #145a32;
                }

                .paid-section .span_tag {
                    display: inline-block;
                    margin-right: 15px;
                    color: #27ae60;
                }
            </style>


            <div class="table-responsive" style="background-color: white;">

                <table class="table table-main" width="100%" id="projectTable">

                    <thead>
                        <tr>
                            <th style="text-align: center;">Quarter</th>
                            <th style="text-align: left;">ExpensesID</th>
                            <th style="text-align: center;">Inv Date</th>
                            <th style="text-align: left;">Supplier</th>
                            <th style="text-align: left;">Terms</th>
                            <th style="text-align: left;">DueDays</th>
                            <th style="text-align: center;">DueDate</th>
                            <th style="text-align:right;">Amount(S$)</th>
                            <th style="text-align:right;">GST(S$)</th>
                            <th style="text-align:right;">Total(S$)</th>
                            <th style="text-align: center;">Status</th>
                            <th style="text-align: center;">Paid On</th>
                        </tr>

                    </thead>

                    <tbody>

                        {% if not grouped_df.empty %}
                        {% for index, row in grouped_df.iterrows() %}

                        <tr class="mainRow">

                            <td class="text-center quarter" style="text-align: center;">{{ row['quarter'] }}</td>

                            <td class="text-center expences_id" style="text-align: left;">
                                {% set exp_id = row['expences_id'] %}
                                {% if row['invoice_file_name'] %}
                                <a href="{{ url_for('view_pay_req_invoice_file', filename=row['invoice_file_name']) }}"
                                    target="_blank">
                                    {% if exp_id.startswith('ER') %}
                                    <span style="color: rgb(12, 176, 241); font-weight: bold;">{{ exp_id }}</span>
                                    {% elif exp_id.startswith('P') %}
                                    <span style="color: blueviolet; font-weight: bold;">{{ exp_id }}</span>
                                    {% elif exp_id.startswith('O') %}
                                    <span style="color: green; font-weight: bold;">{{ exp_id }}</span>
                                    {% elif exp_id.startswith('V') %}
                                    <span style="color: brown; font-weight: bold;">{{ exp_id }}</span>
                                    {% elif exp_id.startswith('E') %}
                                    <span style="color: rgb(28, 125, 236); font-weight: bold;">{{ exp_id }}</span>
                                    {% else %}
                                    <span>{{ exp_id }}</span>
                                    {% endif %}
                                </a>
                                {% else %}
                                {% if exp_id.startswith('ER') %}
                                <span style="color: darkorange; font-weight: bold;">{{ exp_id }}</span>
                                {% elif exp_id.startswith('P') %}
                                <span style="color: blueviolet; font-weight: bold;">{{ exp_id }}</span>
                                {% elif exp_id.startswith('O') %}
                                <span style="color: green; font-weight: bold;">{{ exp_id }}</span>
                                {% elif exp_id.startswith('V') %}
                                <span style="color: brown; font-weight: bold;">{{ exp_id }}</span>
                                {% elif exp_id.startswith('E') %}
                                <span style="color: rgb(28, 125, 236); font-weight: bold;">{{ exp_id }}</span>
                                {% else %}
                                <span>{{ exp_id }}</span>
                                {% endif %}
                                {% endif %}
                            </td>

                            <td class="text-center " style="text-align: center;">{{ row['Invoice_date'] }}</td>
                            <td class="text-center supplier_name">
                                {% if row['expences_id'].startswith('E-') %}
                                {{ row['Sub_Category'] ~ ' - ' ~ row['itemname'] }}
                                {% elif row['supplier_name'] is not none %}
                                {{ row['supplier_name'] }}
                                {% endif %}
                            </td>


                            <td class="text-center" style="text-align: left;">
                                {% if row['time_period'] is not none %}
                                {% if row['time_period'] == 'COD' or row['time_period'] == 'Advance' %}
                                {{ row['time_period'] }}
                                {% else %}
                                {% if row['Terms'] is not none %}
                                {{ row['Terms']|int }} {{ row['time_period'] }}
                                {% endif %}
                                {% endif %}
                                {% endif %}
                            </td>

                            <td class="text-center" style="text-align: left;">
                                {{ row['due_days']|int }} {{ 'Day' if row['due_days']|int == 1 else 'Days' }}
                            </td>
                            <td class="text-center " style="text-align: center;">
                                {% if row['due_date'] %}
                                {{ row['due_date'] }}
                                {% endif %}
                            </td>
                            <td class="amount-cell" style="text-align:right;">{{ "{:,.2f}".format(row['amount']) }}</td>
                            <td class="gst-cell" style="text-align:right;">{{ "{:,.2f}".format(row['gst_value']) }}</td>
                            <td class="total-cell" style="text-align:right;">{{
                                "{:,.2f}".format(row['overall_total_amount']) }}</td>


                            <td class="text-center status" style="font-weight: bold; text-align: center;">
                                <span style="color: 
                                        {% if row['status'] == 'Pending' %}
                                            brown;
                                        {% elif row['status'] == 'Partial' %}
                                            blue;
                                        {% elif row['status'] == 'Paid' %}
                                            green;
                                        {% elif row['status'] == 'Canceled' %}
                                            red;
                                        {% endif %};
                                        background-color: 
                                        {% if row['status'] == 'Pending' %}
                                            #f2e1d7; /* Light brown background */
                                        {% elif row['status'] == 'Partial' %}
                                            #a4acee; /* Light orange background */
                                        {% elif row['status'] == 'Paid' %}
                                            #d0f8e3; /* Light green background */
                                        {% elif row['status'] == 'Canceled' %}
                                            #f8d7da; /* Light red background */
                                        {% endif %};
                                        padding: 2px 8px; 
                                    border-radius: 7px;
                                    display: inline-block;
                                    min-width: 80px;
                                    text-align: center; ">
                                    {{ row['status'] }}
                                </span>
                            </td>

                            <td class=" text-center paid_date1" style="text-align: center;">
                                {% if row['paid_date'] is not none %}
                                {{ row['paid_date'] }}
                                {% endif %}
                            </td>


                        </tr>

                        {% endfor %}

                        {% else %}
                        <tr>
                            <td colspan="14" class="text-center">No Requests available</td>
                        </tr>
                        {% endif %}

                    </tbody>

                    <tfoot>
                        <tr>
                            <td colspan="6" style="text-align:left; font-weight:bold;"></td>
                            <td style="text-align:left; font-weight:bold;">Totals:</td>
                            <td id="totalAmount" style="text-align: right;">45</td>
                            <td id="totalGST" style="text-align: right;">45</td>
                            <td id="overallTotal" style="text-align: right;">45</td>
                            <td style="text-align:right; font-weight:bold;"></td>
                            <td></td>

                        </tr>
                    </tfoot>


                </table>

            </div>

            <script>

                function filterTable() {
                    let input = document.getElementById("searchInput").value.toLowerCase().trim();
                    let keywords = input.split(",").map(k => k.trim()).filter(k => k !== "");

                    let rows = document.querySelectorAll(".mainRow");

                    rows.forEach(row => {
                        let searchableText = [
                            row.querySelector(".quarter"),
                            row.querySelector(".expences_id"),
                            row.querySelector(".supplier_name"),
                            row.querySelector(".paid_date1"),
                            row.querySelector(".status")
                        ].map(el => el ? el.textContent.toLowerCase().trim() : "").join(" ");

                        let shouldShow = keywords.every(keyword => searchableText.includes(keyword));
                        row.style.display = shouldShow ? "" : "none";
                    });

                    updateTotals(); // Combined function now includes footer update too
                }


                function updateTotals() {
                    let pendingAmount = 0, pendingGST = 0, pendingTotal = 0;
                    let paidAmount = 0, paidGST = 0, paidTotal = 0;

                    let footerAmount = 0, footerGST = 0, footerTotal = 0;

                    const rows = document.querySelectorAll("#projectTable tbody tr.mainRow");

                    rows.forEach(row => {
                        if (row.style.display !== "none") {
                            let status = row.querySelector(".status").textContent.trim().toLowerCase();

                            let amount = parseFloat(row.querySelector("td:nth-child(8)").textContent.replace(/[^0-9.-]+/g, "")) || 0;
                            let gstValue = parseFloat(row.querySelector("td:nth-child(9)").textContent.replace(/[^0-9.-]+/g, "")) || 0;
                            let total = parseFloat(row.querySelector("td:nth-child(10)").textContent.replace(/[^0-9.-]+/g, "")) || 0;

                            footerAmount += amount;
                            footerGST += gstValue;
                            footerTotal += total;

                            if (status === "pending" || status === "partial") {
                                pendingAmount += amount;
                                pendingGST += gstValue;
                                pendingTotal += total;
                            } else if (status === "paid") {
                                paidAmount += amount;
                                paidGST += gstValue;
                                paidTotal += total;
                            }
                        }
                    });

                    let formatCurrency = (num) => num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                    // Update Pending totals
                    document.getElementById("pendingAmount").textContent = "S$ " + formatCurrency(pendingAmount);
                    document.getElementById("pendingGST").textContent = "S$ " + formatCurrency(pendingGST);
                    document.getElementById("pendingTotal").textContent = "S$ " + formatCurrency(pendingTotal);

                    // Update Paid totals
                    document.getElementById("paidAmount").textContent = "S$ " + formatCurrency(paidAmount);
                    document.getElementById("paidGST").textContent = "S$ " + formatCurrency(paidGST);
                    document.getElementById("paidTotal").textContent = "S$ " + formatCurrency(paidTotal);

                    // Update Footer Totals (bottom of table)
                    document.getElementById("totalAmount").textContent = "S$ " + formatCurrency(footerAmount);
                    document.getElementById("totalGST").textContent = "S$ " + formatCurrency(footerGST);
                    document.getElementById("overallTotal").textContent = "S$ " + formatCurrency(footerTotal);
                }

                // Initialize and bind search
                document.addEventListener("DOMContentLoaded", updateTotals);
                document.getElementById("searchInput").addEventListener("keyup", function () {
                    filterTable(); // Run filter and update totals together
                });



            </script>

        </div>

    </div>


    <style>
        /* Add shadow and color to the table */
        #projectTable {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            background-color: #fff;
            width: 100%;
        }


        /* Row hover and subtle striping */
        #projectTable tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        #projectTable tbody tr:hover {
            background-color: #f0f8ff;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease;
        }


        .span_tag {
            font-size: 14px;
            font-weight: bold;
            color: #004b5d;
            padding: 2px 4px;
            border: 1px solid #004b5d;
            border-radius: 5px;
            background-color: #f1f8ff;
            color: #004b5d;
            text-align: center;
            margin-right: 10px;
        }

        #totalAmount {
            color: #28a745;
            /* Green for amount */
        }

        #totalGST {
            color: #0c8de2;
            /* Yellow for GST */
        }

        #overallTotal {
            color: #dc3545;
            /* Red for overall total */
        }
    </style>

    <style>
        tfoot {
            position: sticky;
            bottom: 0;
            background-image: linear-gradient(to right, #d8e5f1, #d0e3f7);
            color: #333;
            z-index: 1;
        }

        .search_container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 5px;
        }


        #projectTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
        }


        #searchInput {
            width: 30%;
            padding: 2px;
            margin: auto;
            display: block;
            border: 2px solid #ccc;
            border-radius: 5px;
            /* Rounded corners */
            outline: none;
            transition: all 0.3s ease-in-out;
            text-align: center;
            font-size: 16px;
        }

        #searchInput:hover {
            background-color: #f0f0f0;
        }

        #searchInput:focus {
            border-color: #004b5d;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Function to format a date as DD/MM/YY
            function formatDateAsDDMMYY(dateString) {
                if (!dateString || dateString.toLowerCase() === "none") {
                    return ""; // Return empty string if the date is None or invalid
                }

                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    console.error('Invalid date string:', dateString);
                    return dateString; // Return original if date is invalid
                }

                // Format as DD/MM/YY
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is zero-based
                const year = String(date.getFullYear()).slice(-2); // Get last 2 digits of year

                return `${day}/${month}/${year}`;
            }

            // Function to format date elements
            function formatDateElements(selector) {
                const elements = document.querySelectorAll(selector);
                elements.forEach(function (element) {
                    const text = element.textContent.trim();
                    const formattedDate = formatDateAsDDMMYY(text);
                    element.textContent = formattedDate;
                });
            }

            // Format start-time and end-time elements
            formatDateElements(".start-time");
            formatDateElements(".end-time");
        });
    </script>

</body>

</html>